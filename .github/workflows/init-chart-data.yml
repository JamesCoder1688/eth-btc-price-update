name: Initialize Chart Data (One Time)

on:
  workflow_dispatch: # åªèƒ½æ‰‹åŠ¨è§¦å‘

jobs:
  init-all-chart-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Generate all chart data
        run: |
          echo "ğŸš€ å¼€å§‹ç”Ÿæˆæ‰€æœ‰å›¾è¡¨æ•°æ®..."
          npm run update:chart
          echo "âœ… æ‰€æœ‰å›¾è¡¨æ•°æ®ç”Ÿæˆå®Œæˆ"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº - æ–°çš„ç‹¬ç«‹å›¾è¡¨æ–‡ä»¶
          git add public/eth-chart-*.json || true
          git add public/btc-chart-*.json || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ”¹åŠ¨
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ”¹åŠ¨å¯æäº¤"
            exit 0
          fi
          
          # å°è¯•æäº¤
          git commit -m "åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨æ•°æ® [CI è‡ªåŠ¨]"
          
          # é‡è¯•æ¨é€æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
          for i in {1..3}; do
            echo "å°è¯•æ¨é€ (ç¬¬ $i æ¬¡)"
            if git push origin main; then
              echo "æ¨é€æˆåŠŸ"
              exit 0
            else
              echo "æ¨é€å¤±è´¥ï¼Œå°è¯•é‡æ–°åŒæ­¥"
              git pull --rebase origin main
              sleep 5
            fi
          done
          
          echo "æ¨é€å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡"
          exit 1